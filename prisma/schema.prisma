generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Contact {
  id            String        @id @default(cuid())
  email         String        @unique
  firstName     String?
  lastName      String?
  phone         String?
  districtName  String?
  districtType  String?
  title         String?
  zip           String?
  status        ContactStatus @default(SUBSCRIBED)
  source        String?       @default("import")
  mailchimpLeid String?       @unique
  tags          ContactTag[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

enum ContactStatus {
  SUBSCRIBED
  UNSUBSCRIBED
  CLEANED
}

model Tag {
  id       String       @id @default(cuid())
  name     String       @unique
  contacts ContactTag[]
}

model ContactTag {
  contactId String
  tagId     String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([contactId, tagId])
}

model FormSubmission {
  id        String   @id @default(cuid())
  formType  FormType
  data      Json
  email     String
  notified  Boolean  @default(false)
  createdAt DateTime @default(now())
}

enum FormType {
  CONTACT
  BOOKING
}

model DigestOpen {
  id        String   @id @default(cuid())
  email     String
  digestId  String
  openedAt  DateTime @default(now())

  @@index([email])
  @@index([digestId])
}

model DigestClick {
  id        String   @id @default(cuid())
  email     String
  digestId  String
  url       String
  clickedAt DateTime @default(now())

  @@index([email])
  @@index([digestId])
}

// ── Newsletter Digest Workflow ──────────────────────────────────────

enum DigestStatus {
  PENDING_REVIEW
  APPROVED
  SENDING_BATCH_1
  SENT_BATCH_1
  SENDING_BATCH_2
  SENT_COMPLETE
}

model Digest {
  id          String       @id @default(cuid())
  weekOf      DateTime
  status      DigestStatus @default(PENDING_REVIEW)
  subject     String?
  htmlContent String?      @db.Text
  approvedAt  DateTime?
  approvedBy  String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  candidates DigestCandidate[]
  sends      DigestSend[]
}

model DigestCandidate {
  id        String   @id @default(cuid())
  digestId  String
  position  Int
  title     String
  summary   String   @db.Text
  source    String
  category  String
  link      String
  published DateTime
  isTexas   Boolean  @default(false)
  selected  Boolean  @default(false)
  take      String?  @db.Text

  digest Digest @relation(fields: [digestId], references: [id], onDelete: Cascade)

  @@unique([digestId, position])
  @@index([digestId])
}

model DigestSend {
  id        String   @id @default(cuid())
  digestId  String
  email     String
  sentAt    DateTime @default(now())
  batch     Int

  digest Digest @relation(fields: [digestId], references: [id], onDelete: Cascade)

  @@unique([digestId, email])
  @@index([digestId])
  @@index([email])
}
